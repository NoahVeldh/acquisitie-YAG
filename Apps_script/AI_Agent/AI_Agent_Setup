function callChatGPT_(prompt) {
  const apiKey = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  if (!apiKey) throw new Error('OPENAI_API_KEY ontbreekt in Script Properties');

  const payload = {
    model: 'gpt-4.1-mini',
    //tools: [{ type: 'web_search_preview' }],
    input: [
      {
        role: 'user',
        content: [{ type: 'input_text', text: prompt }]
      }
    ]
  };

  const response = UrlFetchApp.fetch('https://api.openai.com/v1/responses', {
    method: 'post',
    contentType: 'application/json',
    headers: { Authorization: `Bearer ${apiKey}` },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  const body = response.getContentText();
  Logger.log(body);

  const json = JSON.parse(body);
  if (json.error) throw new Error(JSON.stringify(json.error));

  // ✅ 1) Prefer: json.output_text (als aanwezig)
  if (json.output_text && String(json.output_text).trim() !== '') {
    return json.output_text;
  }

  // ✅ 2) Anders: pak de eerste output_text uit output[].content[]
  const out = json.output || [];
  for (const item of out) {
    if (item.type === 'message' && item.content) {
      for (const c of item.content) {
        if (c.type === 'output_text' && c.text) {
          return c.text;
        }
      }
    }
  }

  // ✅ 3) Als echt niets gevonden: gooi error met context
  throw new Error('No output_text found in response payload.');
}

function extractJsonObject_(text) {
  if (!text) throw new Error('Empty AI response');

  let s = String(text).trim();

  // Strip ```json ... ``` of ``` ... ```
  s = s.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '');

  // Pak alleen het eerste JSON object in de tekst
  const start = s.indexOf('{');
  const end = s.lastIndexOf('}');
  if (start === -1 || end === -1 || end <= start) {
    throw new Error('No JSON object found in AI response: ' + s.slice(0, 200));
  }

  return s.slice(start, end + 1);
}


function testChatGPTConnection() {
  const result = callChatGPT_('Say only: OK');
  Logger.log(result);
}

function runAIForSelectedRow() {
  const sheet = getSheet();
  const range = sheet.getActiveRange();
  const row = range.getRow();

  if (row < 2) {
    SpreadsheetApp.getUi().alert('Selecteer een data-rij');
    return;
  }

  const rowData = sheet.getRange(row, 1, 1, 22).getValues()[0];
  const firstName   = rowData[0];
  const jobTitle    = rowData[3];
  const companyName = rowData[4];
  const website     = rowData[5];

  const AI_STATUS_COL  = 23;
  const AI_SUMMARY_COL = 24;
  const AI_MESSAGE_COL = 25;

  sheet.getRange(row, AI_STATUS_COL).setValue('RUNNING');

  // ─── VASTE BLOKKEN ────────────────────────────────────────────────
  const opening = `Ik ben Rick op het Veld, student Technische Bedrijfskunde aan de TU in Eindhoven en werkzaam bij Young Advisory Group (YAG), een volledig studenten-gerund adviesbureau. Omdat wij onze eigen acquisitie doen, ben ik actief op zoek naar bedrijven waar onze kennis waarde kan toevoegen.`;

  const companyPitch = `Met de Young Advisory Group (YAG) hebben we door de jaren heen veel verschillende projecten afgerond in veel verschillende industrieën. Om concrete voorbeelden te geven: recent hebben we gewerkt aan een project voor een bedrijf in de biertank industrie waarbij we geholpen hebben met de implementatie van een ERP systeem. Ook hebben we advies gegeven aan een grote dierentuin hoe zij het beste 'dynamic pricing' kon implementeren. Zelf ben ik nu bezig met een project voor de GGD waarin we gepersonaliseerde brieven opstellen voor 35 gemeenteraden om het belang van gezond opgroeien te benadrukken.

Graag zou ik willen voorstellen om een gesprek in te plannen, waarin we kennis kunnen maken en de mogelijkheden voor een eventuele samenwerking kunnen verkennen.

Ik hoor graag of dit schikt en bij verdere vragen ben ik altijd bereikbaar!`;

  const signature = `Met vriendelijke groet,

Rick op het Veld
Strategy Consultant - Young Advisory Group
–––––––––––––––––––––––––
Vestiging Eindhoven-Tilburg
Videolab
Torenallee 20
5617 BC Eindhoven
+31 6 42 48 16 27
rick.ophetveld@youngadvisorygroup.nl | Linkedin www.youngadvisorygroup.nl`;

  // ─── STAP 1: AI genereert ALLEEN de connectiezinnen ───────────────
  const connectionPrompt = `
Zoek op wat ${companyName} doet (website: ${website}).
De ontvanger is ${firstName}, ${jobTitle} — hij weet wat zijn bedrijf doet, vat het dus NIET samen.

Schrijf precies 2-3 zinnen (platte tekst, geen opmaak, geen links) die uitleggen waarom Rick op het Veld,
student Technische Bedrijfskunde (TU Eindhoven), specifiek bij ${companyName} uitkwam.

Schrijf vanuit Ricks perspectief en interesse: welk thema uit zijn studie (logistiek, processen, strategie,
data, techniek) is relevant voor hun sector? Welk type vraagstuk speelt er in hun branche?
Wees concreet. Verboden: "innovatief", "onder de indruk", "met interesse gevolgd", URLs, of haakjes met links.

Geef ALLEEN de 2-3 zinnen terug, niets anders.
`;

  try {
    const connectionText = callChatGPT_(connectionPrompt).trim();

    // ─── STAP 2: E-mail samenstellen in code ─────────────────────────
    const subject = `Young Advisory Group x ${companyName}`;

    const message = [
      `Beste ${firstName},`,
      '',
      `${opening} ${connectionText} Graag verken ik de mogelijkheden voor een samenwerking.`,
      '',
      companyPitch,
      '',
      signature
    ].join('\n');

    sheet.getRange(row, AI_MESSAGE_COL).setValue(`Onderwerp: ${subject}\n\n${message}`);
    sheet.getRange(row, AI_STATUS_COL).setValue('DONE');

  } catch (e) {
    sheet.getRange(row, AI_STATUS_COL).setValue('ERROR');
    sheet.getRange(row, AI_SUMMARY_COL).setValue(String(e));
    throw e;
  }
}